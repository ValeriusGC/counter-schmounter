# Patch List: Corrections to Local-first Implementation Plan

**Timestamp (Europe/Amsterdam): 2025-12-31 00:38**

Этот документ — **короткий патч-лист** к плану реализации local-first baseline. Он не переписывает план целиком, а фиксирует обязательные правки и уточнения, которые нужно внести перед или в процессе исполнения.

---

## PATCH-01 — Устранить дублирование ViewModel слоёв

### Проблема

В проекте одновременно существуют:

* `lib/src/ui/viewmodels/*`
* `lib/src/presentation/**/viewmodels/*`

Это создаёт архитектурную неоднозначность и риск правок «не в том месте».

### Правка

* Зафиксировать **один** путь как канонический: `lib/src/presentation/**/viewmodels/*`.
* Удалить (или полностью перестать использовать) `lib/src/ui/*` после проверки отсутствия импортов.

### Статус

Обязательная правка **до активной реализации Шагов 2–5**.

---

## PATCH-02 — Optional Auth: поправить CounterScreen

### Проблема

После снятия auth-gate с `/counter`:

* экран всё ещё концептуально «защищён»;
* кнопка `Sign out` отображается даже в local-only режиме.

### Правка

* UI элементов `Sign in / Sign out` должен зависеть от `isAuthenticated`.
* В local-only режиме:

    * не предлагать `Sign out`;
    * не навязывать навигацию на `/login`.

### Статус

Правка обязательна вместе с **Шагом 1 (router)**.

---

## PATCH-03 — Зафиксировать контракт ClientIdentityService

### Проблема

В плане предполагается «синхронный доступ» к `client_id`, но выбранное хранилище (SharedPreferences) инициализируется асинхронно.

### Правка (выбрать и зафиксировать один вариант)

**Вариант A (рекомендуется):**

* `Future<void> init()` — вызывается при старте приложения;
* `String get clientId` — синхронный после init.

**Вариант B:**

* `Future<String> getClientId()` — честный async API.

### Статус

Контракт должен быть выбран **до начала Шага 2**.

---

## PATCH-04 — Упростить агрегацию Counter

### Проблема

Для стенда предлагается отдельный `CounterStateService` с infra-реализацией, что избыточно для одной коммутативной операции.

### Правка

* Реализовать агрегацию как:

    * доменную функцию / утилиту (`CounterAggregator.compute(ops)`),
    * без infrastructure-реализации.

### Статус

Правка обязательна в **Шаге 3**.

---

## PATCH-05 — Ограничить рост Local Op-Log

### Проблема

SharedPreferences не предназначен для неограниченного роста данных, а в плане нет лимитов.

### Правка

Добавить правило для стенда:

* ограничение количества операций **или**
* простая компактация (snapshot + очистка старых ops).

### Статус

Правка обязательна в **Шаге 4**.

---

## PATCH-06 — Стандартизировать стиль Riverpod

### Проблема

В проекте смешаны:

* codegen `@riverpod` Notifier’ы;
* legacy `StateNotifierProvider`.

### Правка

* Зафиксировать **один стиль** для baseline (рекомендуется `@riverpod` + codegen).
* Не добавлять новые провайдеры в альтернативном стиле.

### Статус

Обязательная правка **до начала активной разработки новых сервисов**.

---

## Итог

Без внесения этих патчей:

* baseline будет внутренне противоречивым;
* масштабирование на mft-2 приведёт к рефакторингу вместо расширения.

С этими правками план Курсорыча **можно исполнять напрямую**.
