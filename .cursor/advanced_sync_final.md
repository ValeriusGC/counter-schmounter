# Advanced Sync — Snapshot + Op-Log Semantics (B2/B3)

**Status:** Approved / Design-Locked

Данный документ фиксирует **расширенную спецификацию синхронизации состояния** для production-масштабируемых local-first систем.

Он применяется **строго поверх** baseline-архитектуры:

> *Baseline — Auth + Realtime + Account-Scoped State Synchronization (Canonical)*

Документ **НЕ заменяет baseline** и **НЕ меняет его инварианты**.

---

## 0. Назначение

Цель спецификации — описать корректную модель синхронизации при условиях, когда:

* хранение полного op-log невозможно;
* требуется O(1) восстановление новых реплик;
* применяется compaction истории;
* система эксплуатируется длительное время и на нескольких устройствах.

---

## 1. Предпосылки (обязательные)

Перед применением данной спецификации система **обязана**:

* соответствовать canonical baseline (A1–A3–B1);
* иметь account-scoped local state;
* иметь детерминированный initial sync (B1);
* соблюдать UTC-контракт;
* обеспечивать idempotent apply операций.

Без выполнения этих условий данная спецификация **неприменима**.

---

## 2. Термины

* **Snapshot** — агрегированное состояние сущности на определённой ревизии.
* **Revision** — монотонно возрастающий серверный маркер состояния.
* **Op-Log (bounded)** — ограниченный по размеру журнал операций после snapshot.
* **LocalRevision** — последняя ревизия, применённая на реплике.

---

## 3. Серверная модель хранения

Сервер **обязан** хранить:

### 3.1 Snapshot

* агрегированное состояние сущности;
* `revision`, на которой snapshot валиден.

### 3.2 Ограниченный Op-Log

* операции строго **после snapshot.revision**;
* размер ограничен (например, N = 100);
* старые операции удаляются **только после** фиксации snapshot.

Сервер **НЕ обязан** хранить полный op-log с начала времени.

---

## 4. Алгоритм Sync (revision-based)

### 4.1 Запрос клиента

Клиент передаёт:

* `entity_id`
* `localRevision`

### 4.2 Ответ сервера

Сервер **обязан** вернуть:

* `snapshot`
* `ops[]` (может быть пустым)

---

## 5. Сценарии

### 5.1 Новая реплика (O(1) bootstrap)

Условие:

* `localRevision = 0`

Сервер возвращает:

* snapshot (latest)
* ops = []

Клиент:

1. применяет snapshot;
2. устанавливает `localRevision = snapshot.revision`.

---

### 5.2 Непрерывная история

Условие:

* `localRevision >= snapshot.revision`

Клиент:

1. применяет ops последовательно;
2. обновляет `localRevision`.

---

### 5.3 Разрыв истории (compaction)

Условие:

```
localRevision < snapshot.revision
```

Клиент **обязан**:

1. сбросить локальное агрегированное состояние;
2. применить snapshot;
3. replay ops;
4. установить `localRevision`.

Это поведение **обязательное**, альтернативы запрещены.

---

## 6. Инварианты

1. Snapshot — **не оптимизация**, а часть протокола.
2. Replay ops допустим **только при непрерывной истории**.
3. При разрыве истории snapshot **обязан** применяться.
4. Повторное применение операций не меняет результат.

---

## 7. Связь с Realtime

* Realtime **не меняется** данной спецификацией.
* Любой сигнал, несовместимый с `localRevision`, приводит к `needSync`.

---

## 8. Границы ответственности

* Baseline отвечает за корректность и lifecycle.
* Данный документ отвечает за масштабируемость.

Они **не взаимозаменяемы**.

---

## 9. Статус

**B2/B3 DESIGN LOCKED**

Изменения возможны только при пересмотре baseline.
